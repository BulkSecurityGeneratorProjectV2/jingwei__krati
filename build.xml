<project xmlns:ivy="antlib:org.apache.ivy.ant" name="krati" default="main" basedir=".">
    <property name="project.name" value="krati"/>
    <property name="version" value="0.3.2"/>
    <property name="krati.root" location="."/>
    
    <property name="lib.dir" value="lib"/>
    <property name="test.dir" value="test"/>
    <property name="test.lib.dir" value="${test.dir}/lib"/>
    <property name="build.dir" value="build"/>
    <property name="config.dir" value="config"/>
    <property name="dist.dir" value="dist"/>
    <property name="logs.dir" value="logs"/>
    
    <property name="ivy.jar.dir" value="${basedir}/ivy"/>
    <property name="ivy.jar.file" value="${ivy.jar.dir}/ivy.jar"/>
    <property name="ivy.install.version" value="2.0.0-beta1"/>
    
    <property name="src" value="src"/>
    <property name="cds.src" value="cds/src"/>
    <property name="sos.src" value="sos/src"/>
    
    <property name="test.src" value="${test.dir}/src"/>
    <property name="test.build.dir" value="${test.dir}/classes"/>
    
    <path id="compile.class.path">
        <fileset dir="${lib.dir}">
            <include name="*.jar"/>
        </fileset>
    </path>
    
    <path id="test.compile.class.path">
        <fileset dir="${test.lib.dir}">
            <include name="*.jar"/>
        </fileset>
    </path>
    
    <path id="java.class.path">
        <dirset dir="${build.dir}">
            <include name="**"/>
        </dirset>
    </path>
    
    <path id="test.class.path">
        <dirset dir="${test.build.dir}">
            <include name="**"/>
        </dirset>
    </path>
    
    <target name="download-ivy" unless="skip.download">
    <mkdir dir="${ivy.jar.dir}"/>
        <echo message="installing ivy..."/>
        <get src="http://repo1.maven.org/maven2/org/apache/ivy/ivy/${ivy.install.version}/ivy-${ivy.install.version}.jar" dest="${ivy.jar.file}" usetimestamp="true"/>
    </target>
    
    <target name="install-ivy" depends="download-ivy" description="-- install ivy">
        <path id="ivy.lib.path">
            <fileset dir="${ivy.jar.dir}" includes="*.jar"/>
        </path>
        <taskdef resource="org/apache/ivy/ant/antlib.xml" uri="antlib:org.apache.ivy.ant" classpathref="ivy.lib.path"/>
    </target>
    
    <target name="resolve" depends="install-ivy">
        <ivy:retrieve />
    </target>
    
    <target name="clean">
      <delete dir="${build.dir}"/>
      <delete dir="${dist.dir}"/>
      <delete dir="${logs.dir}"/>
      <delete dir="${test.build.dir}"/>
    </target>
    
    <target name="init" depends="resolve">
        <mkdir dir="${build.dir}"/>
        <mkdir dir="${dist.dir}"/>
        <mkdir dir="${logs.dir}"/>
    </target>
    
    <target name="compile.krati" depends="init">
        <javac debug="true" destdir="${build.dir}">
            <src path="${src}"/>
            <classpath refid="compile.class.path"/>
        </javac>
    </target>
    
    <target name="compile.cds" depends="compile.krati">
        <javac debug="true" destdir="${build.dir}">
            <src path="${cds.src}/api"/>
            <src path="${cds.src}/impl"/>
            <classpath refid="java.class.path"/>
            <classpath refid="compile.class.path"/>
        </javac>
    </target>
    
    <target name="compile.sos" depends="compile.cds">
        <javac debug="true" destdir="${build.dir}">
            <src path="${sos.src}"/>
            <classpath refid="java.class.path"/>
            <classpath refid="compile.class.path"/>
        </javac>
    </target>
    
    <target name="compile" depends="init">
        <javac debug="true" destdir="${build.dir}">
            <src path="${src}"/>
            <src path="${cds.src}/api"/>
            <src path="${cds.src}/impl"/>
            <src path="${sos.src}"/>
            <classpath refid="compile.class.path"/>
        </javac>
        <copy todir="${build.dir}">
            <fileset dir="${config.dir}"/>
        </copy>
    </target>
    
    <target name="dist" depends="compile">
            <jar destfile="${dist.dir}/${project.name}-${version}.jar" basedir="${build.dir}" />
    </target>
    
    <target name="test.clean" description="-- clean test results">
      <delete dir="${logs.dir}"/>
      <delete dir="${test.build.dir}"/>
      <delete dir="${test.dir}/cache"/>
      <delete dir="${test.dir}/output"/>
    </target>
    
    <target name="test.init" depends="compile">
        <mkdir dir="${test.build.dir}"/>
    </target>
    
    <target name="test.compile" depends="test.init">
        <javac debug="true" destdir="${test.build.dir}">
            <src path="${test.src}"/>
            <classpath refid="java.class.path"/>
            <classpath refid="compile.class.path"/>
            <classpath refid="test.compile.class.path"/>
        </javac>
        <copy todir="${test.build.dir}">
            <fileset dir="${config.dir}"/>
        </copy>
    </target>
    
    <target name="test" depends="test.compile" description="-- run regression (30 seconds per test)">
        <junit printsummary="yes" maxmemory="10G">
            <jvmarg value="-Dtest.idStart=0"/>
            <jvmarg value="-Dtest.idCount=500000"/>
            <jvmarg value="-Dtest.segFileSizeMB=128"/>
            <jvmarg value="-Dtest.runTimeSeconds=30"/>
            <jvmarg value="-Dtest.dir=${test.dir}"/>
            <jvmarg value="-Dtest.output.dir=${test.dir}/output"/>
            <formatter type="brief" usefile="false"/>
            
            <classpath>
                <path refid="test.class.path"/>
                <path refid="java.class.path"/>
                <path refid="compile.class.path"/>
                <path refid="test.compile.class.path"/>
            </classpath>
            
            <batchtest fork="yes">
                <fileset dir="${test.build.dir}" includes="**/Test*.class" excludes="**/Test*er.class"/>
            </batchtest>
        </junit>
    </target>
    
    <target name="test.stress" depends="test.compile" description="-- run regression (30 minutes per test)">
        <junit printsummary="yes" maxmemory="16G">
            <jvmarg value="-Dtest.idStart=0"/>
            <jvmarg value="-Dtest.idCount=5000000"/>
            <jvmarg value="-Dtest.segFileSizeMB=256"/>
            <jvmarg value="-Dtest.runTimeSeconds=1800"/>
            <jvmarg value="-Dtest.dir=${test.dir}"/>
            <jvmarg value="-Dtest.output.dir=${test.dir}/output"/>
            <formatter type="brief" usefile="false"/>
            
            <classpath>
                <path refid="test.class.path"/>
                <path refid="java.class.path"/>
                <path refid="compile.class.path"/>
                <path refid="test.compile.class.path"/>
            </classpath>
            
            <batchtest fork="yes">
                <fileset dir="${test.build.dir}" includes="**/Test*.class" excludes="**/Test*er.class"/>
            </batchtest>
        </junit>
    </target>

    <target name="regress.cache" depends="test.compile" description="-- regress DataCache for memory/mapped/channel (30 minutes per test)">
        <junit printsummary="yes" maxmemory="16G">
            <jvmarg value="-Dtest.idStart=0"/>
            <jvmarg value="-Dtest.idCount=5000000"/>
            <jvmarg value="-Dtest.segFileSizeMB=256"/>
            <jvmarg value="-Dtest.runTimeSeconds=1800"/>
            <jvmarg value="-Dtest.dir=${test.dir}"/>
            <jvmarg value="-Dtest.output.dir=${test.dir}/output"/>
            <formatter type="brief" usefile="false"/>
            
            <classpath>
                <path refid="test.class.path"/>
                <path refid="java.class.path"/>
                <path refid="compile.class.path"/>
                <path refid="test.compile.class.path"/>
            </classpath>
            
            <batchtest fork="yes">
                <fileset dir="${test.build.dir}" includes="**/TestDataCache*.class" excludes="**/Test*er.class"/>
            </batchtest>
        </junit>
    </target>

    <target name="regress.store" depends="test.compile" description="-- regress DataStore for memory/mapped/channel (30 minutes per test)">
        <junit printsummary="yes" maxmemory="16G">
            <jvmarg value="-Dtest.idStart=0"/>
            <jvmarg value="-Dtest.idCount=5000000"/>
            <jvmarg value="-Dtest.segFileSizeMB=256"/>
            <jvmarg value="-Dtest.runTimeSeconds=1800"/>
            <jvmarg value="-Dtest.dir=${test.dir}"/>
            <jvmarg value="-Dtest.output.dir=${test.dir}/output"/>
            <formatter type="brief" usefile="false"/>
            
            <classpath>
                <path refid="test.class.path"/>
                <path refid="java.class.path"/>
                <path refid="compile.class.path"/>
                <path refid="test.compile.class.path"/>
            </classpath>
            
            <batchtest fork="yes">
                <fileset dir="${test.build.dir}" includes="**/Test*Store*.class" excludes="**/Test*er.class"/>
            </batchtest>
        </junit>
    </target>

    <target name="test.quick" description="-- run a quick test on DataCache" depends="test.compile">
        <junit printsummary="yes" maxmemory="4G">
            <jvmarg value="-Dtest.idStart=0"/>
            <jvmarg value="-Dtest.idCount=200000"/>
            <jvmarg value="-Dtest.segFileSizeMB=100"/>
            <jvmarg value="-Dtest.runTimeSeconds=60"/>
            <jvmarg value="-Dtest.dir=${test.dir}"/>
            <jvmarg value="-Dtest.output.dir=${test.dir}/output"/>
            <formatter type="brief" usefile="false"/>
            
            <classpath>
                <path refid="test.class.path"/>
                <path refid="java.class.path"/>
                <path refid="compile.class.path"/>
                <path refid="test.compile.class.path"/>
            </classpath>
            
            <batchtest fork="yes">
                <fileset dir="${test.build.dir}" includes="**/TestDataCache.class"/>
            </batchtest>
        </junit>
    </target>

    <target name="test.Xprof" description="-- run profiling on DataCache (5 minutes)" depends="test.compile">
        <junit printsummary="yes" maxmemory="4G">
            <jvmarg value="-Xprof"/>
            <jvmarg value="-Dtest.idStart=0"/>
            <jvmarg value="-Dtest.idCount=200000"/>
            <jvmarg value="-Dtest.segFileSizeMB=100"/>
            <jvmarg value="-Dtest.runTimeSeconds=300"/>
            <jvmarg value="-Dtest.dir=${test.dir}"/>
            <jvmarg value="-Dtest.output.dir=${test.dir}/output"/>
            <formatter type="brief" usefile="false"/>
            
            <classpath>
                <path refid="test.class.path"/>
                <path refid="java.class.path"/>
                <path refid="compile.class.path"/>
                <path refid="test.compile.class.path"/>
            </classpath>
            
            <batchtest fork="yes">
                <fileset dir="${test.build.dir}" includes="**/TestDataCache.class"/>
            </batchtest>
        </junit>
    </target>

    <target name="main" depends="dist">
    </target>
</project>
